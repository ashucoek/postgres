CREATE EXTENSION IF NOT EXISTS pg_tde;
SELECT extname, extversion FROM pg_extension WHERE extname = 'pg_tde';
 extname | extversion 
---------+------------
 pg_tde  | 1.0-rc
(1 row)

CREATE TABLE test_enc (id SERIAL, k INTEGER, PRIMARY KEY (id)) USING tde_heap;
psql:<stdin>:1: ERROR:  principal key not configured
HINT:  create one using pg_tde_set_key before using encrypted tables
SELECT pg_tde_add_database_key_provider_file('file-vault', '/tmp/pg_tde_test_001_basic.per');
 pg_tde_add_database_key_provider_file 
---------------------------------------
                                     1
(1 row)

SELECT pg_tde_set_key_using_database_key_provider('test-db-key', 'file-vault');
 pg_tde_set_key_using_database_key_provider 
--------------------------------------------
 
(1 row)

CREATE TABLE test_enc (id SERIAL, k VARCHAR(32), PRIMARY KEY (id)) USING tde_heap;
INSERT INTO test_enc (k) VALUES ('foobar'), ('barfoo');
SELECT * FROM test_enc ORDER BY id;
 id |   k    
----+--------
  1 | foobar
  2 | barfoo
(2 rows)

-- server restart
SELECT * FROM test_enc ORDER BY id;
 id |   k    
----+--------
  1 | foobar
  2 | barfoo
(2 rows)

TABLEFILE FOUND: yes
CONTAINS FOO (should be empty): 
SELECT pg_tde_verify_key()
psql:<stdin>:1: ERROR:  failed to retrieve principal key test-db-key from keyring with ID 1
DROP TABLE test_enc;
DROP EXTENSION pg_tde;
