CREATE EXTENSION IF NOT EXISTS pg_tde;
SELECT pg_tde_add_database_key_provider_file('file-vault', '/tmp/change_key_provider_1.per');
 pg_tde_add_database_key_provider_file 
---------------------------------------
 
(1 row)

SELECT pg_tde_list_all_database_key_providers();
                pg_tde_list_all_database_key_providers                 
-----------------------------------------------------------------------
 (1,file-vault,file,"{""path"" : ""/tmp/change_key_provider_1.per""}")
(1 row)

SELECT pg_tde_set_key_using_database_key_provider('test-key', 'file-vault');
 pg_tde_set_key_using_database_key_provider 
--------------------------------------------
 
(1 row)

CREATE TABLE test_enc (id serial, k integer, PRIMARY KEY (id)) USING tde_heap;
INSERT INTO test_enc (k) VALUES (5), (6);
SELECT pg_tde_verify_key();
 pg_tde_verify_key 
-------------------
 
(1 row)

SELECT pg_tde_is_encrypted('test_enc');
 pg_tde_is_encrypted 
---------------------
 t
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

-- mv /tmp/change_key_provider_1.per /tmp/change_key_provider_2.per
SELECT pg_tde_change_database_key_provider_file('file-vault', '/tmp/change_key_provider_2.per');
 pg_tde_change_database_key_provider_file 
------------------------------------------
 
(1 row)

SELECT pg_tde_list_all_database_key_providers();
                pg_tde_list_all_database_key_providers                 
-----------------------------------------------------------------------
 (1,file-vault,file,"{""path"" : ""/tmp/change_key_provider_2.per""}")
(1 row)

SELECT pg_tde_verify_key();
 pg_tde_verify_key 
-------------------
 
(1 row)

SELECT pg_tde_is_encrypted('test_enc');
 pg_tde_is_encrypted 
---------------------
 t
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

-- server restart
SELECT pg_tde_verify_key();
 pg_tde_verify_key 
-------------------
 
(1 row)

SELECT pg_tde_is_encrypted('test_enc');
 pg_tde_is_encrypted 
---------------------
 t
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

DROP EXTENSION pg_tde CASCADE;
psql:<stdin>:1: NOTICE:  drop cascades to table test_enc
