CREATE EXTENSION pg_tde;
SELECT pg_tde_add_database_key_provider_file('file-vault', '/tmp/rotate_key.per');
 pg_tde_add_database_key_provider_file 
---------------------------------------
 
(1 row)

SELECT pg_tde_add_database_key_provider_file('file-2', '/tmp/rotate_key_2.per');
 pg_tde_add_database_key_provider_file 
---------------------------------------
 
(1 row)

SELECT pg_tde_add_global_key_provider_file('file-2', '/tmp/rotate_key_2g.per');
 pg_tde_add_global_key_provider_file 
-------------------------------------
 
(1 row)

SELECT pg_tde_add_global_key_provider_file('file-3', '/tmp/rotate_key_3.per');
 pg_tde_add_global_key_provider_file 
-------------------------------------
 
(1 row)

SELECT pg_tde_list_all_database_key_providers();
           pg_tde_list_all_database_key_providers           
------------------------------------------------------------
 (1,file-vault,file,"{""path"" : ""/tmp/rotate_key.per""}")
 (2,file-2,file,"{""path"" : ""/tmp/rotate_key_2.per""}")
(2 rows)

SELECT pg_tde_create_key_using_database_key_provider('test-db-key', 'file-vault');
 pg_tde_create_key_using_database_key_provider 
-----------------------------------------------
 
(1 row)

SELECT pg_tde_set_key_using_database_key_provider('test-db-key', 'file-vault');
 pg_tde_set_key_using_database_key_provider 
--------------------------------------------
 
(1 row)

CREATE TABLE test_enc (id SERIAL, k INTEGER, PRIMARY KEY (id)) USING tde_heap;
INSERT INTO test_enc (k) VALUES (5), (6);
SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

SELECT pg_tde_create_key_using_database_key_provider('rotated-key1', 'file-vault');
 pg_tde_create_key_using_database_key_provider 
-----------------------------------------------
 
(1 row)

SELECT pg_tde_set_key_using_database_key_provider('rotated-key1', 'file-vault');
 pg_tde_set_key_using_database_key_provider 
--------------------------------------------
 
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

-- server restart
SELECT provider_id, provider_name, key_name FROM pg_tde_key_info();
 provider_id | provider_name |   key_name   
-------------+---------------+--------------
           1 | file-vault    | rotated-key1
(1 row)

SELECT provider_id, provider_name, key_name FROM pg_tde_server_key_info();
 provider_id | provider_name | key_name 
-------------+---------------+----------
             |               | 
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

SELECT pg_tde_create_key_using_database_key_provider('rotated-key2', 'file-2');
 pg_tde_create_key_using_database_key_provider 
-----------------------------------------------
 
(1 row)

SELECT pg_tde_set_key_using_database_key_provider('rotated-key2', 'file-2');
 pg_tde_set_key_using_database_key_provider 
--------------------------------------------
 
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

-- server restart
SELECT provider_id, provider_name, key_name FROM pg_tde_key_info();
 provider_id | provider_name |   key_name   
-------------+---------------+--------------
           2 | file-2        | rotated-key2
(1 row)

SELECT provider_id, provider_name, key_name FROM pg_tde_server_key_info();
 provider_id | provider_name | key_name 
-------------+---------------+----------
             |               | 
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

SELECT pg_tde_create_key_using_global_key_provider('rotated-key', 'file-3');
 pg_tde_create_key_using_global_key_provider 
---------------------------------------------
 
(1 row)

SELECT pg_tde_set_key_using_global_key_provider('rotated-key', 'file-3');
 pg_tde_set_key_using_global_key_provider 
------------------------------------------
 
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

-- server restart
SELECT provider_id, provider_name, key_name FROM pg_tde_key_info();
 provider_id | provider_name |  key_name   
-------------+---------------+-------------
          -2 | file-3        | rotated-key
(1 row)

SELECT provider_id, provider_name, key_name FROM pg_tde_server_key_info();
 provider_id | provider_name | key_name 
-------------+---------------+----------
             |               | 
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

SELECT pg_tde_create_key_using_global_key_provider('rotated-keyX', 'file-2');
 pg_tde_create_key_using_global_key_provider 
---------------------------------------------
 
(1 row)

SELECT pg_tde_set_key_using_global_key_provider('rotated-keyX', 'file-2');
 pg_tde_set_key_using_global_key_provider 
------------------------------------------
 
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

-- server restart
SELECT provider_id, provider_name, key_name FROM pg_tde_key_info();
 provider_id | provider_name |   key_name   
-------------+---------------+--------------
          -1 | file-2        | rotated-keyX
(1 row)

SELECT provider_id, provider_name, key_name FROM pg_tde_server_key_info();
 provider_id | provider_name | key_name 
-------------+---------------+----------
             |               | 
(1 row)

SELECT * FROM test_enc ORDER BY id;
 id | k 
----+---
  1 | 5
  2 | 6
(2 rows)

ALTER SYSTEM SET pg_tde.inherit_global_providers = off;
-- server restart
SELECT pg_tde_create_key_using_global_key_provider('rotated-keyX2', 'file-2');
psql:<stdin>:1: ERROR:  usage of global key providers is disabled
HINT:  Set "pg_tde.inherit_global_providers = on" in postgresql.conf.
SELECT pg_tde_set_key_using_global_key_provider('rotated-keyX2', 'file-2');
psql:<stdin>:1: ERROR:  usage of global key providers is disabled
HINT:  Set "pg_tde.inherit_global_providers = on" in postgresql.conf.
SELECT provider_id, provider_name, key_name FROM pg_tde_key_info();
 provider_id | provider_name |   key_name   
-------------+---------------+--------------
          -1 | file-2        | rotated-keyX
(1 row)

SELECT provider_id, provider_name, key_name FROM pg_tde_server_key_info();
 provider_id | provider_name | key_name 
-------------+---------------+----------
             |               | 
(1 row)

SELECT pg_tde_set_key_using_database_key_provider('rotated-key2', 'file-2');
 pg_tde_set_key_using_database_key_provider 
--------------------------------------------
 
(1 row)

SELECT provider_id, provider_name, key_name FROM pg_tde_key_info();
 provider_id | provider_name |   key_name   
-------------+---------------+--------------
           2 | file-2        | rotated-key2
(1 row)

SELECT provider_id, provider_name, key_name FROM pg_tde_server_key_info();
 provider_id | provider_name | key_name 
-------------+---------------+----------
             |               | 
(1 row)

DROP TABLE test_enc;
ALTER SYSTEM RESET pg_tde.inherit_global_providers;
-- server restart
DROP EXTENSION pg_tde CASCADE;
