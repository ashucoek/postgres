CREATE EXTENSION IF NOT EXISTS pg_tde;
SELECT pg_tde_add_global_key_provider_file('global_keyring', '/tmp/crash_recovery.per');
 pg_tde_add_global_key_provider_file 
-------------------------------------
 
(1 row)

SELECT pg_tde_set_server_key_using_global_key_provider('wal_encryption_key', 'global_keyring');
 pg_tde_set_server_key_using_global_key_provider 
-------------------------------------------------
 
(1 row)

SELECT pg_tde_add_database_key_provider_file('db_keyring', '/tmp/crash_recovery.per');
 pg_tde_add_database_key_provider_file 
---------------------------------------
 
(1 row)

SELECT pg_tde_set_key_using_database_key_provider('db_key', 'db_keyring');
 pg_tde_set_key_using_database_key_provider 
--------------------------------------------
 
(1 row)

CREATE TABLE test_enc (x int PRIMARY KEY) USING tde_heap;
INSERT INTO test_enc (x) VALUES (1), (2);
CREATE TABLE test_plain (x int PRIMARY KEY) USING heap;
INSERT INTO test_plain (x) VALUES (3), (4);
ALTER SYSTEM SET pg_tde.wal_encrypt = 'on';
-- kill -9
-- server start
-- rotate wal key
SELECT pg_tde_set_server_key_using_global_key_provider('wal_encryption_key_1', 'global_keyring');
 pg_tde_set_server_key_using_global_key_provider 
-------------------------------------------------
 
(1 row)

SELECT pg_tde_set_key_using_database_key_provider('db_key_1', 'db_keyring');
 pg_tde_set_key_using_database_key_provider 
--------------------------------------------
 
(1 row)

INSERT INTO test_enc (x) VALUES (3), (4);
-- kill -9
-- server start
-- check that pg_tde_save_principal_key_redo hasn't destroyed a WAL key created during the server start
-- rotate wal key
SELECT pg_tde_set_server_key_using_global_key_provider('wal_encryption_key_2', 'global_keyring');
 pg_tde_set_server_key_using_global_key_provider 
-------------------------------------------------
 
(1 row)

SELECT pg_tde_set_key_using_database_key_provider('db_key_2', 'db_keyring');
 pg_tde_set_key_using_database_key_provider 
--------------------------------------------
 
(1 row)

INSERT INTO test_enc (x) VALUES (5), (6);
-- kill -9
-- server start
-- check that the key rotation hasn't destroyed a WAL key created during the server start
TABLE test_enc;
 x 
---
 1
 2
 3
 4
 5
 6
(6 rows)

CREATE TABLE test_enc2 (x int PRIMARY KEY) USING tde_heap;
-- kill -9
-- server start
-- check redo of the smgr internal key creation when the key is on disk
